name: Build and Release

on:
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: server/go.sum

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create build directory
        run: mkdir -p build

      - name: Build frontend
        working-directory: ./web
        run: |
          npm install
          npm run build

      - name: Build backend binaries
        working-directory: ./server
        run: |
          go mod download
          export LDFLAGS="-s -w"
          
          # Linux AMD64
          GOOS=linux GOARCH=amd64 go build -ldflags="$LDFLAGS" -o ../build/goban-linux-amd64 .
          
          # Linux ARM64
          GOOS=linux GOARCH=arm64 go build -ldflags="$LDFLAGS" -o ../build/goban-linux-arm64 .
          
          # Windows AMD64
          GOOS=windows GOARCH=amd64 go build -ldflags="$LDFLAGS" -o ../build/goban-windows-amd64.exe .
          
          # macOS AMD64
          GOOS=darwin GOARCH=amd64 go build -ldflags="$LDFLAGS" -o ../build/goban-darwin-amd64 .
          
          # macOS ARM64
          GOOS=darwin GOARCH=arm64 go build -ldflags="$LDFLAGS" -o ../build/goban-darwin-arm64 .

      - name: Compress binaries
        run: |
          cd build
          tar -czf goban-linux-amd64.tar.gz goban-linux-amd64
          tar -czf goban-linux-arm64.tar.gz goban-linux-arm64
          tar -czf goban-darwin-amd64.tar.gz goban-darwin-amd64
          tar -czf goban-darwin-arm64.tar.gz goban-darwin-arm64
          zip goban-windows-amd64.zip goban-windows-amd64.exe
          
          # Remove uncompressed binaries
          rm goban-linux-* goban-darwin-* goban-windows-*.exe
          ls -lh

      - name: Compress frontend
        run: |
          cd web
          tar -czf ../build/goban-web.tar.gz dist/
          cd ../build
          ls -lh

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="dev-build-${{ steps.date.outputs.date }}"
          
          gh release create "$TAG_NAME" \
            --title "Development Build $TAG_NAME" \
            --notes "Automated development build created on $(date +'%Y-%m-%d %H:%M:%S')" \
            --draft \
            ./build/goban-linux-amd64.tar.gz \
            ./build/goban-linux-arm64.tar.gz \
            ./build/goban-darwin-amd64.tar.gz \
            ./build/goban-darwin-arm64.tar.gz \
            ./build/goban-windows-amd64.zip \
            ./build/goban-web.tar.gz
